{"version":3,"sources":["../../src/pages/lobby/lobby.module.ts","../../src/pages/lobby/lobby.ts"],"names":[],"mappings":"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","file":"4.js","sourcesContent":["import { NgModule } from '@angular/core';\nimport { IonicPageModule } from 'ionic-angular';\nimport { LobbyPage } from './lobby';\n\n@NgModule({\n  declarations: [\n    LobbyPage,\n  ],\n  imports: [\n    IonicPageModule.forChild(LobbyPage),\n  ],\n})\nexport class LobbyPageModule {}\n\n\n\n// WEBPACK FOOTER //\n// ./src/pages/lobby/lobby.module.ts","import { Component } from '@angular/core';\nimport { IonicPage, NavController, NavParams } from 'ionic-angular';\nimport { AngularFireDatabase } from 'angularfire2/database';\nimport { Observable } from 'rxjs/Observable';\nimport { UserModel } from '../../Models/user.model';\nimport { RoomModel } from '../../Models/room.model';\nimport { AuthService } from '../../services/auth.service'\nimport { RoomsService } from '../../services/rooms.service';\nimport { RoundModel } from '../../Models/round.model';\nimport { LoadingController } from 'ionic-angular';\nimport { AlertController } from 'ionic-angular';\nimport { MessagesService } from '../../services/messages.service';\nimport { HomePage } from '../home/home'\n\n@IonicPage()\n@Component({\n  selector: 'page-lobby',\n  templateUrl: 'lobby.html'\n})\nexport class LobbyPage {\n\n  roomKey: string;\n  roomsItems: Observable<RoomModel>;\n  users: Observable<UserModel[]>;\n  isOwner: Boolean;\n  selectorUserKey: string; \n  spyUser: string;\n  roomName: string;\n  usersInRoomKey: string;\n  loader: any;\n  entryCode: string;\n  currentRound: string;\n  enterToSettings: Boolean;\n\n  constructor(public navCtrl: NavController, public navParams: NavParams, \n              public af: AngularFireDatabase, private authService: AuthService,\n              private roomService: RoomsService, public loadingCtrl: LoadingController,\n              public alertCtrl: AlertController, public msgService: MessagesService) {\n    \n    console.log(\"ctor of lobby\");\n    // Get thr paramters from the navigation controller\n    this.roomKey = this.navParams.get('roomKey');\n\n   // find the room by the given entry code\n   this.findRoom();\n\n    // load the users from the room\n    this.loadUsers();\n\n    // check if the room is closed by the owner\n    this.roomService.checkRoomClosed(this.isOwner, () => { this.navCtrl.popToRoot(); });\n  }\n\n  ionViewDidEnter() {\n    // this workaround helps when we leave the page only for settings page\n    // and do not want the room to prepare it again.\n    if(!this.enterToSettings)\n      this.prepareRoom();\n    this.enterToSettings = false;\n  }\n\n  private prepareRoom() {\n    let subscription = this.af.list(`rounds/${this.roomKey}/`).subscribe(t=>{\n      t.forEach(r=>{\n        console.log(\"in foreach\");\n        if(r != null && r.roomKey == this.roomKey && r.state != \"done\"){\n          this.currentRound = r.$key;\n          subscription.unsubscribe();\n          this.af.object(`rounds/${this.roomKey}/${this.currentRound}/isCategorySelected`).subscribe(category => {\n            console.log(\"category selected - changed\");\n            if(category.$value){\n              this.dismissLoading();\n              this.navCtrl.push('GamePage', {roundKey: this.currentRound});\n            }\n          });\n          this.af.object(`rounds/${this.roomKey}/${this.currentRound}/selectorKey`).subscribe(selector => {\n            if(selector.$value == this.authService.currentUser.$key){\n              console.log(\"selector key - changed\");\n              this.navCtrl.push('ChooseCategoryPage', {roundKey: this.currentRound , roomKey: this.roomKey});\n            }\n            else if(selector.$value != null) {\n              this.presentLoading();\n            }\n          });\n        }\n      });\n    });\n  }\n\n  private findRoom(){\n      // Get the current room\n      let subscription = this.af.object(`/rooms/${this.roomKey}`).subscribe( t=> {\n        this.roomName = t.roomName;\n        if(t.owner == this.authService.currentUser.displayName)\n            this.isOwner = true;\n        else {\n            this.roomService.updateUsersInRoom(this.roomKey);      \n        }\n\n        this.entryCode = t.entryCode;\n        if(subscription != null)\n          subscription.unsubscribe();\n    })\n  }\n\n  private loadUsers() {\n      this.roomService.loadUsers(this.isOwner, this.currentRound, this.roomKey,\n      () => {\n        if(this.navCtrl.getActive().name != \"LobbyPage\")\n          this.navCtrl.popTo(this.navCtrl.getByIndex(1));\n      });\n  }\n    \n  private raffleSpy(){ \n     let spyRandNumber = Math.floor(Math.random() * this.roomService.usersModel.length );\n     this.spyUser = this.roomService.usersModel[spyRandNumber].$key;\n     \n     this.roomService.setSpy(this.spyUser);\n  }\n\n  private raffleSelector(){ \n    let spyRandNumber = Math.floor(Math.random() * this.roomService.usersModel.length);\n\n    this.selectorUserKey = this.roomService.usersModel[spyRandNumber].$key;\n  }\n  \n  presentLoading() {\n    this.loader = this.loadingCtrl.create({\n      content: \"Please wait...\",\n    });\n    this.loader.present();\n  }\n\n  dismissLoading() {\n    if(this.loader != null)\n      this.loader.dismiss();\n  }\n\n  startGame() {\n      \n      if(this.roomService.usersCount < 4 && !this.authService.IsDebug) {\n        this.msgService.showMsg(\"Sorry\", \"The round can be executed only for 4 players and above.\");\n        return;\n      }\n      console.log(\"start game - room key\" + this.roomKey);\n      this.roomService.updateUsersInRoom(this.roomKey);\n      // raffle spy and category selector  \n      this.raffleSelector(); \n      this.raffleSpy();\n\n      let round: RoundModel = {\n        categoryKey: \"\",\n        selectorKey: this.selectorUserKey,\n        spyKey: this.spyUser,\n        roomKey: this.roomKey,\n        secret: 0,\n        votesCount: 0\n      }\n\n      this.af.list(`rounds/${this.roomKey}/`).push(round);\n\n      // Add new room to the db\n      this.af.object(`rooms/${this.roomKey}/isStarted`).set(true);\n      this.af.object(`rooms/${this.roomKey}/usersCount`).set(this.roomService.usersCount);\n\n      let sub = this.af.object(`rooms/${this.roomKey}/roundsInterval`).subscribe(t=>{\n        debugger;\n        if(sub != null){\n          console.log(\"unsubscribe\");\n          sub.unsubscribe();\n        }\n        if(t != null){\n          let intervals = t.$value;\n          intervals++;\n          this.af.object(`rooms/${this.roomKey}/roundsInterval`).set(intervals);\n        }\n      });\n  }\n\n  public exit() {\n    let alert = this.alertCtrl.create({\n      title: 'Attention?',\n      message: 'Are you sure that you want to leave the room?',\n      buttons: [\n        {\n          text: 'Cancel',\n          role: 'cancel',\n          handler: () => {\n          }\n        },\n        {\n          text: 'Leave',\n          handler: () => {\n            this.leaveRoom();\n          }\n        }\n      ]\n    });\n    alert.present();\n  }\n\n  private leaveRoom() {\n    console.log(\"leave room from lobby\");\n    this.roomService.leaveRoom(this.isOwner);\n    this.navCtrl.popToRoot();\n  }\n\n  public goSettings() {\n    this.enterToSettings = true;\n    this.navCtrl.push('SettingsPage', {roomKey: this.roomKey});\n  }\n\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/pages/lobby/lobby.ts"],"sourceRoot":""}